<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Weedle â€” Guess the daily strain</title>

<style>
/* style B) */
:root{
  --bg:#f6f7f8;
  --card:#ffffff;
  --muted:#6b7280;
  --green:#6aaa64;
  --yellow:#c9b458;
  --gray:#787c7e;
  --max-width:760px;
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto;
}
html,body{margin:0; background:var(--bg); color:#0b1220;}
.wrap{display:flex; justify-content:center; padding:30px 12px;}
.card{width:100%; max-width:var(--max-width); background:var(--card); padding:20px; border-radius:14px; box-shadow:0 8px 40px rgba(0,0,0,0.06);}/* ... all other CSS unchanged ... */
</style>
</head>

<body>
<div class="wrap">
<div class="card">

<header>
  <img id="logo" src="images/weedle.jpg" alt="weedle logo">
  <div>
    <h1>Weedle â€” Guess the daily strain</h1>
    <div style="font-size:13px; color:var(--muted); margin-top:6px;">
      Guess the daily strain using Wordle-style clues.
    </div>
  </div>
</header>

<div id="strainImageBox">
  <img id="strainImage" src="">
  <div id="strainLabel"></div>
</div>

<div class="controls">
  <div id="guessContainer">
    <input id="guessInput" autocomplete="off" placeholder="Type to search strainsâ€¦" />
    <div id="dropdown"></div>
  </div>
  <button id="submitBtn">Submit</button>
  <button id="resetBtn">Reset</button>
</div>

<table>
<thead>
<tr>
  <th>Strain</th>
  <th>Letters</th>
  <th>Type</th>
  <th>THC %</th>
  <th>Dominant Terpene</th>
  <th>Year</th>
</tr>
</thead>
<tbody id="guessesBody"></tbody>
</table>

<div id="success">ðŸŽ‰ You found todayâ€™s strain! ðŸŽ‰</div>

</div>
</div>

<script>
let strains = [];
let mystery;
let guessCount = 0;

fetch("strains.json")
  .then(res => res.json())
  .then(data => { strains = data; initializeGame(); });

function initializeGame() {
  const strainsWithImages = strains.filter(s => s.image);
  const pool = strainsWithImages.length ? strainsWithImages : strains;

  function dailyIndex(date = new Date()) {
    const epoch = Date.UTC(2023, 0, 1);
    const today = Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate());
    return Math.floor((today - epoch) / (1000*60*60*24)) % pool.length;
  }

  mystery = pool[dailyIndex()];
  loadDailyStrainImage();
  enableInputHandlers();
}

function loadDailyStrainImage() {
  const strainImageEl = document.getElementById("strainImage");
  const strainLabelEl = document.getElementById("strainLabel");

  const today = new Date();
  const dateStr = today.toLocaleDateString("en-US", {
    weekday:"long", month:"long", day:"numeric", year:"numeric"
  });

  strainLabelEl.textContent = `Strain of the Day â€” ${dateStr}`;

  if (mystery.image) {
    strainImageEl.src = "images/" + mystery.image;
    strainImageEl.style.display = "block";
  } else {
    strainImageEl.style.display = "none";
  }
}

const strip = s => s.replace(/\s+/g,'');
const letters = s => strip(s).length;
const arrow = (g,t)=> g===t ? "" : (g<t?"â†‘":"â†“");

function alphaProximityColor(guessName, mysteryName) {
  const guessLower = guessName.toLowerCase();
  const mysteryLower = mysteryName.toLowerCase();
  if (guessLower === mysteryLower) return "green";
  const g = guessLower[0];
  const m = mysteryLower[0];
  if (Math.abs(g.charCodeAt(0)-m.charCodeAt(0))<=1) return "yellow";
  return "gray";
}

function typeProximityColor(guessType, mysteryType) {
  const order=["sativa","sativa/hybrid","hybrid","indica/hybrid","indica"];
  const gi=order.indexOf(guessType.toLowerCase());
  const mi=order.indexOf(mysteryType.toLowerCase());
  if(gi===-1||mi===-1) return "gray";
  if(gi===mi) return "green";
  return Math.abs(gi-mi)===1?"yellow":"gray";
}

function colorNum(g,t,threshold){
  if(g===t) return "green";
  if(Math.abs(g-t)<=threshold) return "yellow";
  return "gray";
}

function enableInputHandlers() {
  const guessInput = document.getElementById("guessInput");
  const dropdown = document.getElementById("dropdown");

  guessInput.addEventListener("input", e => {
    const q = e.target.value.trim().toLowerCase();
    dropdown.innerHTML = "";
    if (!q) { dropdown.style.display = "none"; return; }

    const matches = strains.filter(s => s.name.toLowerCase().startsWith(q));
    matches.forEach(s => {
      const d=document.createElement("div");
      d.className="dd-item";
      d.textContent=s.name;
      d.onclick=()=>{ guessInput.value=s.name; dropdown.style.display="none"; };
      dropdown.appendChild(d);
    });

    dropdown.style.display = matches.length ? "block" : "none";
  });

  document.getElementById("submitBtn").onclick = submitGuess;
  document.getElementById("resetBtn").onclick = resetGame;
}

function resetGame() {
  document.getElementById("guessesBody").innerHTML="";
  document.getElementById("success").style.display="none";
  document.getElementById("guessInput").value="";
  guessCount = 0;
}

function submitGuess() {
  const raw=document.getElementById("guessInput").value.trim();
  if(!raw) return alert("Select a strain from the dropdown.");

  const guess=strains.find(s=>s.name.toLowerCase()===raw.toLowerCase());
  if(!guess) return alert("Strain must be from the database.");

  const alreadySolved = document.getElementById("success").style.display !== "none";
  const isCorrect = guess.name.toLowerCase() === mystery.name.toLowerCase();

  if (!alreadySolved) {
    guessCount++;
  }

  const tr=document.createElement("tr");

  const nameTd=document.createElement("td");
  nameTd.appendChild(tile(guess.name, alphaProximityColor(guess.name, mystery.name)));

  const ls=letters(guess.name);
  const lt=letters(mystery.name);
  const lettersTd=document.createElement("td");
  lettersTd.appendChild(tile(`${ls} ${arrow(ls,lt)}`, colorNum(ls,lt,1)));

  const typeTd=document.createElement("td");
  typeTd.appendChild(tile(guess.type, typeProximityColor(guess.type, mystery.type)));

  const thcTd=document.createElement("td");
  thcTd.appendChild(tile(`${guess.thc}% ${arrow(guess.thc,mystery.thc)}`, colorNum(guess.thc,mystery.thc,2)));

  const terpTd=document.createElement("td");
  terpTd.appendChild(tile(guess.terpene, guess.terpene.toLowerCase()===mystery.terpene.toLowerCase()?"green":"gray"));

  const yearTd=document.createElement("td");
  yearTd.appendChild(tile(`${guess.year} ${arrow(guess.year,mystery.year)}`, colorNum(guess.year,mystery.year,2)));

  tr.appendChild(nameTd);
  tr.appendChild(lettersTd);
  tr.appendChild(typeTd);
  tr.appendChild(thcTd);
  tr.appendChild(terpTd);
  tr.appendChild(yearTd);

  document.getElementById("guessesBody").appendChild(tr);
  flipTilesSequential(tr);

  if (isCorrect && !alreadySolved) {
    document.getElementById("success").style.display="block";
    showStatsOverlay();
  }

  document.getElementById("guessInput").value="";
}

async function showStatsOverlay() {
  const overlay=document.getElementById("statsOverlay");
  const yourResult=document.getElementById("yourResult");
  const barsBox=document.getElementById("statsBars");

  const strainName=mystery.name;
  const today=new Date().toISOString().slice(0,10);

  yourResult.textContent=`You solved it in ${guessCount} guesses.`;

  fetch("https://weedle.sammywhlee.workers.dev/submit",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({strain:strainName,guesses:guessCount,date:today})
  }).catch(()=>{});

  let global={};
  try{
    const res=await fetch(`https://weedle.sammywhlee.workers.dev/stats?strain=${encodeURIComponent(strainName)}`);
    global=await res.json();
  }catch(e){ global={}; }

  barsBox.innerHTML="";
  const keys=Object.keys(global).sort((a,b)=>Number(a)-Number(b));
  if(keys.length===0){ barsBox.innerHTML="<div>No global data yet.</div>"; }
  else{
    const max=Math.max(...keys.map(k=>global[k]));
    keys.forEach(k=>{
      const count=global[k];
      const pct=Math.max(10,Math.round((count/max)*100));
      const row=`
        <div class="barRow">
          <div class="barLabel">${k}</div>
          <div class="barOuter"><div class="barFill" style="width:${pct}%">${count}</div></div>
        </div>`;
      barsBox.innerHTML+=row;
    });
  }

  overlay.classList.remove("overlayHidden");
  document.getElementById("closeOverlay").onclick=()=>{
    overlay.classList.add("overlayHidden");
  };
}

function tile(content,color){
  const el=document.createElement("span");
  el.className=`tile flip ${color}`;
  el.textContent=content;
  return el;
}

function flipTilesSequential(container){
  const tiles=[...container.querySelectorAll(".tile")];
  tiles.forEach((t,i)=>{
    setTimeout(()=>{ t.classList.remove("flip"); t.classList.add("show"); },i*180);
  });
}
</script>

<div id="statsOverlay" class="overlayHidden">
  <div id="statsBox">
    <h2>STATISTICS</h2>
    <p id="yourResult"></p>
    <div id="globalTitle">GUESS DISTRIBUTION</div>
    <div id="statsBars"></div>
    <button id="closeOverlay">Close</button>
  </div>
</div>

</body>
</html>
