<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Weedle — guess the daily strain</title>
<style>
  :root{
    --bg:#0f1724; --card:#0b1220; --accent:#8ee7a6; --muted:#94a3b8;
    --correct:#16a34a; --close:#f59e0b; --wrong:#ef4444;
    font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  body{background:linear-gradient(180deg,#071024 0%, #071b2b 100%); color:#e6eef6; margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px;}
  .app{width:100%; max-width:820px;}
  header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px;}
  h1{font-size:1.5rem; margin:0; color:var(--accent);}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:18px; box-shadow:0 8px 24px rgba(2,6,23,0.6);}
  .controls{display:flex; gap:8px; align-items:center;}
  input[type="text"]{background:transparent; color:inherit; border:1px solid rgba(255,255,255,0.06); padding:8px 10px; border-radius:8px; min-width:220px;}
  button{background:var(--accent); color:#062022; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600;}
  button.secondary{background:transparent; color:var(--accent); border:1px solid rgba(255,255,255,0.03);}
  .hint-note{color:var(--muted); font-size:0.9rem; margin-top:8px;}
  .board{margin-top:16px; display:flex; flex-direction:column; gap:10px;}
  .guess-row{display:flex; gap:10px; align-items:stretch; flex-wrap:wrap;}
  .tile{flex:1 1 120px; min-width:120px; background:rgba(255,255,255,0.02); padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.02);}
  .tile h3{margin:0 0 6px 0; font-size:0.95rem;}
  .tile p{margin:0; color:var(--muted); font-size:0.95rem;}
  .stat.correct{background:linear-gradient(90deg, rgba(22,163,74,0.12), rgba(22,163,74,0.06)); border:1px solid rgba(22,163,74,0.15);}
  .stat.close{background:linear-gradient(90deg, rgba(245,158,11,0.08), rgba(245,158,11,0.04)); border:1px solid rgba(245,158,11,0.12);}
  .stat.wrong{background:linear-gradient(90deg, rgba(239,68,68,0.06), rgba(239,68,68,0.02)); border:1px solid rgba(239,68,68,0.12);}
  .small{font-size:0.85rem; color:var(--muted); margin-top:6px;}
  footer{margin-top:14px; display:flex; justify-content:space-between; align-items:center; color:var(--muted); font-size:0.9rem;}
  @media (max-width:640px){
    .tile{flex:1 1 100%;}
    input[type="text"]{min-width:140px;}
  }
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>Weedle — guess the daily strain</h1>
    <div class="controls">
      <button id="helpBtn" class="secondary" aria-label="How to play">How to play</button>
      <button id="resetBtn" class="secondary" aria-label="Reset today's game">Reset</button>
    </div>
  </header>

  <main class="card" role="main" aria-live="polite">
    <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
      <label for="guessInput" style="display:block; font-weight:600; min-width:80px;">Your guess</label>
      <input id="guessInput" type="text" placeholder="e.g. Blue Dream" aria-label="Type a strain name"/>
      <button id="submitBtn">Guess</button>
      <div style="margin-left:auto; text-align:right;">
        <div style="font-size:0.85rem; color:var(--muted)">Day: <span id="dayLabel"></span></div>
        <div style="font-size:0.75rem; color:var(--muted)">Guesses: <span id="countLabel">0</span></div>
      </div>
    </div>

    <div class="hint-note">
      Each guess reveals attribute clues: strain name (match/existence), type (indica/sativa/hybrid), THC % (higher/lower/close), dominant terpene (match or not), and debut year (earlier/later/close).
    </div>

    <div class="board" id="board" aria-live="polite"></div>

    <footer>
      <div>Tip: Add strains to the `strains` array in the code to expand the game.</div>
      <div id="resultMsg"></div>
    </footer>
  </main>
</div>

<script>
/*
Weedle starter JS
- Replace or expand `strains` with a richer dataset.
- Deterministic daily selection uses days since epoch modulo list length.
- Feedback rules are intentionally simple and tweakable.
*/

// ----- Sample strains database (replace/extend as needed) -----
const strains = [
  // name, type, thc (number), terpene, debutYear
  { name: "Blue Dream", type: "sativa", thc: 18, terpene: "myrcene", year: 2003 },
  { name: "OG Kush", type: "hybrid", thc: 20, terpene: "limonene", year: 1996 },
  { name: "Girl Scout Cookies", type: "hybrid", thc: 22, terpene: "caryophyllene", year: 2012 },
  { name: "Sour Diesel", type: "sativa", thc: 19, terpene: "limonene", year: 1991 },
  { name: "Northern Lights", type: "indica", thc: 17, terpene: "myrcene", year: 1985 },
  { name: "White Widow", type: "hybrid", thc: 16, terpene: "pinene", year: 1994 },
  { name: "Granddaddy Purple", type: "indica", thc: 21, terpene: "myrcene", year: 2000 },
  { name: "Jack Herer", type: "sativa", thc: 18, terpene: "terpinolene", year: 1995 },
  { name: "Durban Poison", type: "sativa", thc: 16, terpene: "terpinolene", year: 1970 },
  { name: "Purple Haze", type: "sativa", thc: 15, terpene: "pinene", year: 1967 }
];

// Normalize helpers
const normalize = s => String(s||"").trim().toLowerCase();

// find strain by exact name (case-insensitive)
function findStrainByName(name) {
  const n = normalize(name);
  return strains.find(s => normalize(s.name) === n) || null;
}

// Simple name similarity: percent of shared letters (set intersection)
function nameSimilarity(a, b) {
  const sa = normalize(a).replace(/\s+/g,'');
  const sb = normalize(b).replace(/\s+/g,'');
  const setA = new Set(sa);
  const setB = new Set(sb);
  let common = 0;
  for (let ch of setA) if (setB.has(ch)) common++;
  return Math.round((common / Math.max(setA.size, setB.size)) * 100);
}

// deterministic daily index
function dailyIndexForDate(d = new Date()) {
  const msPerDay = 24*60*60*1000;
  const epoch = Date.UTC(2023,0,1); // Jan 1 2023 seed epoch (arbitrary)
  const days = Math.floor((Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()) - epoch) / msPerDay);
  return Math.abs(days) % strains.length;
}

const todayIndex = dailyIndexForDate(new Date());
const todaysStrain = strains[todayIndex];

// DOM refs
const board = document.getElementById('board');
const guessInput = document.getElementById('guessInput');
const submitBtn = document.getElementById('submitBtn');
const dayLabel = document.getElementById('dayLabel');
const countLabel = document.getElementById('countLabel');
const resultMsg = document.getElementById('resultMsg');
const helpBtn = document.getElementById('helpBtn');
const resetBtn = document.getElementById('resetBtn');

// show day label
(function(){ const d = new Date(); dayLabel.textContent = d.toISOString().slice(0,10); })();

// localStorage key per day so each day is independent
const storageKey = `weedle_guesses_${new Date().toISOString().slice(0,10)}`;

function loadGuesses() {
  try {
    const raw = localStorage.getItem(storageKey);
    if (!raw) return [];
    return JSON.parse(raw);
  } catch (e) {
    return [];
  }
}
function saveGuesses(gs) {
  localStorage.setItem(storageKey, JSON.stringify(gs));
}

// render board
function renderBoard() {
  const guesses = loadGuesses();
  board.innerHTML = '';
  guesses.forEach(g => {
    const row = document.createElement('div');
    row.className = 'guess-row';
    // For each attribute we make a tile
    const tiles = buildFeedbackTiles(g);
    tiles.forEach(t => row.appendChild(t));
    board.appendChild(row);
  });
  countLabel.textContent = guesses.length;
}

// build feedback tiles for a guess object { raw, matchedStrain? }
function buildFeedbackTiles(guessObj) {
  const raw = guessObj.raw;
  const guessed = guessObj.matched || findStrainByName(raw);
  const tiles = [];

  // Name tile
  const nameTile = document.createElement('div');
  nameTile.className = 'tile stat ' + (guessed && normalize(guessed.name) === normalize(todaysStrain.name) ? 'correct' : (guessed ? 'close' : 'wrong'));
  nameTile.innerHTML = `<h3>Strain</h3><p>${escapeHtml(raw)}</p><div class="small">${guessed ? (normalize(guessed.name) === normalize(todaysStrain.name) ? 'Exact match!' : 'Name found in DB') : 'Not in DB'}</div>`;
  tiles.push(nameTile);

  // Type tile (indica/sativa/hybrid)
  const typeTile = document.createElement('div');
  const typeStatus = guessed ? (normalize(guessed.type) === normalize(todaysStrain.type) ? 'correct' : 'wrong') : 'wrong';
  typeTile.className = `tile stat ${typeStatus}`;
  typeTile.innerHTML = `<h3>Type</h3><p>${guessed ? guessed.type : '—'}</p><div class="small">${typeStatus === 'correct' ? 'Matches' : (guessed ? 'Does not match' : 'Unknown') }</div>`;
  tiles.push(typeTile);

  // THC tile: show guessed THC if in DB, else show '—'. Provide directional hint.
  const thcTile = document.createElement('div');
  let thcClass = 'wrong';
  let thcText = '—';
  let thcSmall = '';
  if (guessed && typeof guessed.thc === 'number') {
    thcText = `${guessed.thc}%`;
    const diff = guessed.thc - todaysStrain.thc;
    const abs = Math.abs(diff);
    if (diff === 0) { thcClass = 'correct'; thcSmall = 'Exact THC'; }
    else if (abs <= 2) { thcClass = 'close'; thcSmall = `Close — ${diff>0? 'Higher' : 'Lower'} by ${abs}%`; }
    else { thcClass = 'wrong'; thcSmall = `${diff>0? 'Higher' : 'Lower'} by ${abs}%`; }
  } else {
    thcSmall = 'Unknown';
  }
  thcTile.className = `tile stat ${thcClass}`;
  thcTile.innerHTML = `<h3>THC</h3><p>${thcText}</p><div class="small">${thcSmall}</div>`;
  tiles.push(thcTile);

  // Terpene tile
  const terpTile = document.createElement('div');
  let terpClass = 'wrong';
  let terpText = '—';
  if (guessed && guessed.terpene) {
    terpText = guessed.terpene;
    terpClass = normalize(guessed.terpene) === normalize(todaysStrain.terpene) ? 'correct' : 'wrong';
  } else {
    terpText = 'Unknown';
    terpClass = 'wrong';
  }
  terpTile.className = `tile stat ${terpClass}`;
  terpTile.innerHTML = `<h3>Dominant terpene</h3><p>${escapeHtml(terpText)}</p><div class="small">${terpClass==='correct' ? 'Match' : 'No match'}</div>`;
  tiles.push(terpTile);

  // Debut year tile: earlier/later/close/correct
  const yearTile = document.createElement('div');
  let yearClass = 'wrong';
  let yearText = '—';
  let yearSmall = '';
  if (guessed && guessed.year) {
    yearText = guessed.year;
    const diff = guessed.year - todaysStrain.year;
    const abs = Math.abs(diff);
    if (diff === 0) { yearClass = 'correct'; yearSmall = 'Exact year'; }
    else if (abs <= 3) { yearClass = 'close'; yearSmall = diff>0 ? `Debuted later by ${abs}y` : `Debuted earlier by ${abs}y`; }
    else { yearClass = 'wrong'; yearSmall = diff>0 ? 'Debuted later' : 'Debuted earlier'; }
  } else {
    yearText = 'Unknown';
    yearSmall = 'Unknown';
  }
  yearTile.className = `tile stat ${yearClass}`;
  yearTile.innerHTML = `<h3>Debut year</h3><p>${yearText}</p><div class="small">${yearSmall}</div>`;
  tiles.push(yearTile);

  // Optional: similarity tile to help for name closeness
  const sim = nameSimilarity(raw, todaysStrain.name);
  const simTile = document.createElement('div');
  simTile.className = 'tile';
  simTile.innerHTML = `<h3>Name similarity</h3><p>${sim}%</p><div class="small">Helps when DB doesn't contain your guess</div>`;
  tiles.push(simTile);

  return tiles;
}

// Escape HTML helper
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// handle guess submit
function handleGuessSubmission() {
  const raw = guessInput.value.trim();
  if (!raw) return;
  const guesses = loadGuesses();
  if (guesses.some(g => normalize(g.raw) === normalize(raw))) {
    alert('You already guessed that name.');
    return;
  }

  const matched = findStrainByName(raw);
  const guessObj = { raw, ts: Date.now(), matched: matched || null };
  guesses.push(guessObj);
  saveGuesses(guesses);
  renderBoard();
  guessInput.value = '';
  checkForWin(guessObj);
}

// Check if guess is correct and show message
function checkForWin(guessObj) {
  if (guessObj.matched && normalize(guessObj.matched.name) === normalize(todaysStrain.name)) {
    resultMsg.innerHTML = `<strong style="color:var(--correct)">You found it! Today's strain is <em>${escapeHtml(todaysStrain.name)}</em>.</strong>`;
    // optionally reveal full metadata
    showReveal();
  } else if (loadGuesses().length >= 6) {
    resultMsg.innerHTML = `<span style="color:var(--wrong)">Out of guesses — Today's strain was <em>${escapeHtml(todaysStrain.name)}</em>.</span>`;
    showReveal();
  } else {
    resultMsg.textContent = '';
  }
}

// reveal the full solution below board
function showReveal() {
  const revealRow = document.createElement('div');
  revealRow.className = 'guess-row';
  const info = [
    { title: 'Strain', val: todaysStrain.name },
    { title: 'Type', val: todaysStrain.type },
    { title: 'THC', val: `${todaysStrain.thc}%` },
    { title: 'Terpene', val: todaysStrain.terpene },
    { title: 'Debut Year', val: todaysStrain.year }
  ];
  info.forEach(i => {
    const t = document.createElement('div');
    t.className = 'tile stat correct';
    t.innerHTML = `<h3>${i.title}</h3><p>${escapeHtml(String(i.val))}</p>`;
    revealRow.appendChild(t);
  });
  // only add reveal once
  if (!document.getElementById('revealRow')) {
    revealRow.id = 'revealRow';
    board.appendChild(revealRow);
  }
}

// reset game for today (clears localStorage entry)
function resetToday() {
  if (confirm('Clear guesses for today?')) {
    localStorage.removeItem(storageKey);
    resultMsg.textContent = '';
    renderBoard();
  }
}

// help modal simple alert
helpBtn.addEventListener('click', () => {
  alert(
`How to play Weedle
- Each day there is a single target strain.
- Type any strain name (free text). If it exists in the internal DB, more precise attribute info will be used.
- After each guess you get five attribute clues:
  1) Strain (exact / found / not in DB)
  2) Type (indica / sativa / hybrid) — match or not
  3) THC % — exact / close (±2%) / higher/lower
  4) Dominant terpene — match or not
  5) Debut year — earlier/later/close (±3 years)
- You have up to 6 guesses. Expand the strains array in the code to add more names.
Enjoy!`
  );
});

resetBtn.addEventListener('click', resetToday);
submitBtn.addEventListener('click', handleGuessSubmission);
guessInput.addEventListener('keydown', e => { if (e.key === 'Enter') handleGuessSubmission(); });

// on load, render any saved guesses
renderBoard();
// reveal if already won or exhausted
const existing = loadGuesses();
if (existing.some(g => g.matched && normalize(g.matched.name) === normalize(todaysStrain.name))) {
  resultMsg.innerHTML = `<strong style="color:var(--correct)">You found it earlier today — Today's strain is <em>${escapeHtml(todaysStrain.name)}</em>.</strong>`;
  showReveal();
} else if (existing.length >= 6) {
  resultMsg.innerHTML = `<span style="color:var(--wrong)">No guesses left — Today's strain was <em>${escapeHtml(todaysStrain.name)}</em>.</span>`;
  showReveal();
}
</script>
</body>
</html>
