<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weedle</title>
<style>
body { font-family: Arial, sans-serif; background:#111; color:white; margin:0; padding:0; text-align:center; }
#header { font-size:42px; margin-top:20px; font-weight:bold; letter-spacing:3px; }
#dateDisplay { margin-top:6px; font-size:18px; opacity:0.8; }
#strainImage { margin-top:20px; }
#strainImage img { width:260px; border-radius:12px; }
input { width:260px; padding:10px; border-radius:5px; border:none; margin-top:20px; font-size:16px; }
#guesses { margin:0 auto; margin-top:25px; width:90%; max-width:750px; }
table { width:100%; border-collapse:collapse; }
th,td { padding:8px; border-bottom:1px solid #333; }
.green { background:#6aaa64; color:white; padding:6px 10px; border-radius:6px; display:inline-block; }
.yellow { background:#c9b458; color:white; padding:6px 10px; border-radius:6px; display:inline-block; }
.gray { background:#3a3a3c; color:white; padding:6px 10px; border-radius:6px; display:inline-block; }

/* Overlay for stats */
#statsOverlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); display:flex; justify-content:center; align-items:center; z-index:9999;}
.overlayHidden{display:none!important;}
#statsBox{background:white;width:92%;max-width:480px;padding:24px;border-radius:12px;text-align:center;color:black;}
#statsBox h2{margin:0 0 18px 0;font-weight:bold;font-size:24px;}
#globalTitle{margin-top:16px;font-size:18px;font-weight:bold;}
.barRow{display:flex;align-items:center;margin:6px 0;}
.barLabel{width:24px;text-align:right;font-weight:bold;}
.barOuter{flex:1;background:#ddd;height:20px;margin-left:8px;border-radius:4px;overflow:hidden;}
.barFill{height:100%;background:#6aaa64;text-align:right;color:white;padding-right:6px;font-size:12px;}
#closeOverlay{margin-top:20px;padding:10px 22px;background:#6aaa64;border:none;border-radius:6px;color:white;cursor:pointer;font-size:16px;}
</style>
</head>
<body>

<div id="header">WEEDLE</div>
<div id="dateDisplay"></div>
<div id="strainImage"></div>
<input id="guessInput" placeholder="Enter strain name..." list="strainList" />
<datalist id="strainList"></datalist>

<div id="success" style="display:none; margin-top:20px; font-size:22px; color:#6aaa64;">Correct!</div>

<div id="guesses">
<table>
<thead>
<tr>
<th>Strain</th><th>Letters</th><th>Type</th><th>THC %</th><th>Terpene</th><th>Year</th>
</tr>
</thead>
<tbody id="guessesBody"></tbody>
</table>
</div>

<!-- Stats modal -->
<div id="statsOverlay" class="overlayHidden">
  <div id="statsBox">
    <h2>STATISTICS</h2>
    <p id="yourResult"></p>
    <div id="globalTitle">GUESS DISTRIBUTION</div>
    <div id="statsBars"></div>
    <button id="closeOverlay">Close</button>
  </div>
</div>

<script>
let strains=[]; 
let mystery=null;
let guessCount=0;

// Load strains and begin daily game
fetch("strains.json").then(r=>r.json()).then(data=>{
  strains=data;
  initializeGame();
});

function initializeGame(){
  guessCount=0; // reset guess counter daily

  document.getElementById("dateDisplay").textContent=new Date().toDateString();

  // Pick daily strain
  const strainsWithImages = strains.filter(s => !!s.image);
  const seed=Math.floor(Date.now()/86400000)%strainsWithImages.length;
  mystery=strainsWithImages[seed];

  // Load strain image
  const img=document.createElement("img");
  img.src=mystery.image;
  img.onerror=()=>{ img.style.display="none"; };
  document.getElementById("strainImage").appendChild(img);

  // Fill autocomplete
  let dl="";
  strains.forEach(s=> dl+=`<option value="${s.name}"></option>`);
  document.getElementById("strainList").innerHTML=dl;
}

document.getElementById("guessInput").addEventListener("keydown",e=>{
  if(e.key==="Enter") submitGuess();
});

function letters(n){ return n.replace(/[^A-Za-z]/g,"").length; }
function arrow(a,b){ return a<b?"↑":a>b?"↓":""; }

function tile(text,color){
  const d=document.createElement("div");
  d.className=color;
  d.textContent=text;
  return d;
}

function colorNum(a,b,tol){
  if(a===b) return "green";
  if(Math.abs(a-b)<=tol) return "yellow";
  return "gray";
}

function alphaProximityColor(g,m){
  g=g.toLowerCase(); m=m.toLowerCase();
  if(g===m) return "green";
  if(Math.abs(g.charCodeAt(0)-m.charCodeAt(0))<=1) return "yellow";
  return "gray";
}

function typeProximityColor(g,m){
  const order=["sativa","sativa/hybrid","hybrid","indica/hybrid","indica"];
  const gi=order.indexOf(g.toLowerCase());
  const mi=order.indexOf(m.toLowerCase());
  if(gi===mi) return "green";
  if(Math.abs(gi-mi)<=1) return "yellow";
  return "gray";
}

// Handle guesses
function submitGuess(){
  const raw=document.getElementById("guessInput").value.trim();
  if(!raw) return;

  const guess=strains.find(s=>s.name.toLowerCase()===raw.toLowerCase());
  if(!guess) return;

  guessCount++;

  const tr=document.createElement("tr");

  tr.appendChild(tileCell(guess.name, alphaProximityColor(guess.name,mystery.name)));

  const ls=letters(guess.name);
  const lt=letters(mystery.name);
  tr.appendChild(tileCell(`${ls} ${arrow(ls,lt)}`, colorNum(ls,lt,1)));

  tr.appendChild(tileCell(guess.type, typeProximityColor(guess.type,mystery.type)));

  tr.appendChild(tileCell(`${guess.thc}% ${arrow(guess.thc,mystery.thc)}`, colorNum(guess.thc,mystery.thc,2)));

  tr.appendChild(tileCell(guess.terpene, guess.terpene.toLowerCase()===mystery.terpene.toLowerCase()?"green":"gray"));

  tr.appendChild(tileCell(`${guess.year} ${arrow(guess.year,mystery.year)}`, colorNum(guess.year,mystery.year,2)));

  document.getElementById("guessesBody").appendChild(tr);

  if(guess.name.toLowerCase()===mystery.name.toLowerCase()){
    document.getElementById("success").style.display="block";
    showStatsOverlay();
  }

  document.getElementById("guessInput").value="";
}

function tileCell(text,color){
  const td=document.createElement("td");
  td.appendChild(tile(text,color));
  return td;
}

// Reset UI manually
function resetGame(){
  document.getElementById("guessesBody").innerHTML="";
  document.getElementById("success").style.display="none";
  document.getElementById("guessInput").value="";
  guessCount=0;
}

// Show global stats
async function showStatsOverlay(){
  const overlay=document.getElementById("statsOverlay");
  const yourResult=document.getElementById("yourResult");
  const barsBox=document.getElementById("statsBars");

  yourResult.textContent=`You solved it in ${guessCount} guesses.`;

  // Submit result
  fetch("https://weedle.sammywhlee.workers.dev/submit",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      strain:mystery.name,
      guesses:guessCount,
      date:new Date().toISOString().slice(0,10)
    })
  }).catch(()=>{});

  // Load global stats
  let global={};
  try{
    const r=await fetch(`https://weedle.sammywhlee.workers.dev/stats?strain=${encodeURIComponent(mystery.name)}`);
    global=await r.json();
  }catch(e){
    global={};
  }

  barsBox.innerHTML="";
  const keys=Object.keys(global).sort((a,b)=>a-b);

  if(keys.length===0){
    barsBox.innerHTML="<div>No global data yet.</div>";
  } else {
    const max=Math.max(...keys.map(k=>global[k]));
    keys.forEach(k=>{
      const count=global[k];
      const pct=Math.round(count/max*100);
      barsBox.innerHTML+=`
      <div class="barRow">
        <div class="barLabel">${k}</div>
        <div class="barOuter">
          <div class="barFill" style="width:${pct}%">${count}</div>
        </div>
      </div>`;
    });
  }

  overlay.classList.remove("overlayHidden");
  document.getElementById("closeOverlay").onclick=()=>overlay.classList.add("overlayHidden");
}
</script>
</body>
</html>
